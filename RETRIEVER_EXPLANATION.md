# Retriever 설명 가이드

## Retriever란?

**Retriever (검색기)**는 정보 검색 시스템에서 사용자의 질의(query)에 관련된 정보를 데이터베이스나 지식 저장소에서 찾아서 반환하는 컴포넌트입니다.

GraphRAG (Graph + Retrieval Augmented Generation) 시스템에서는 그래프 데이터베이스(Neo4j)에서 관련 정보를 검색하여 LLM에게 제공하는 역할을 합니다.

---

## 1. Text2Cypher Retriever

### 개념
자연어 질의를 **Cypher 쿼리**로 변환하여 Neo4j 그래프 데이터베이스에서 구조적 정보를 검색합니다.

### 작동 방식
1. **LLM을 사용하여 자연어 → Cypher 변환**
   - 사용자 질의: "모든 카테고리 목록을 보여줘"
   - 생성된 Cypher: `MATCH (c:Category) RETURN c`
2. **Cypher 쿼리 실행**
   - Neo4j에서 쿼리를 실행하여 노드와 관계를 반환
3. **결과 반환**
   - 검색된 노드와 관계를 반환

### 장점
- **구조적 질문에 강함**: "언론사별 기사 수", "카테고리 목록" 등
- **정확한 관계 탐색**: 그래프 구조를 직접 활용
- **명확한 결과**: 쿼리가 명확하면 결과도 명확

### 단점
- **LLM 의존성**: LLM이 잘못된 Cypher를 생성할 수 있음
- **복잡한 의미 검색 어려움**: "AI 관련 뉴스" 같은 의미 기반 검색은 부적합
- **오류 처리 필요**: 잘못된 Cypher 쿼리 실행 시 오류 발생

### 적합한 질의 예시
- "모든 카테고리 목록"
- "언론사별 기사 수"
- "기사와 콘텐츠의 관계 구조"
- "특정 카테고리에 속한 기사들"

---

## 2. Vector Retriever

### 개념
**임베딩(Embedding)** 벡터를 사용하여 의미적으로 유사한 콘텐츠를 검색합니다.

### 작동 방식
1. **질의 임베딩 생성**
   - 사용자 질의를 벡터로 변환 (예: "경제 뉴스" → [0.1, 0.3, -0.2, ...])
2. **벡터 유사도 검색**
   - Neo4j Vector Index를 사용하여 유사한 Content 노드 검색
   - 코사인 유사도(Cosine Similarity)로 점수 계산
3. **상위 K개 선택**
   - 유사도 점수가 높은 순서대로 상위 K개 선택
   - 임계값(similarity_threshold) 이상인 것만 포함

### 장점
- **의미 기반 검색**: 키워드가 정확히 일치하지 않아도 의미가 유사하면 찾을 수 있음
- **빠른 검색**: Vector Index를 사용하면 매우 빠름
- **짧은 질의에 적합**: "AI", "경제" 같은 간단한 키워드 검색

### 단점
- **정확도 한계**: 의미적으로 유사하지만 실제로는 관련 없는 콘텐츠가 포함될 수 있음
   - 예: "해킹 방지" 검색 시 검찰청 관련 기사가 선택될 수 있음
- **중복 노드**: 같은 노드가 여러 번 반환될 수 있음 (수정됨)
- **구조 정보 부족**: Content 노드만 반환하고 관계 정보는 없음

### 적합한 질의 예시
- "AI"
- "경제 뉴스"
- "기술 트렌드"
- "정치 동향"

---

## 3. VectorCypher Retriever

### 개념
**Vector 검색 + 그래프 확장**을 결합한 하이브리드 방식입니다.

### 작동 방식
1. **Vector 검색으로 초기 노드 찾기**
   - Vector Retriever를 사용하여 관련 Content 노드 검색
2. **그래프 확장**
   - 찾은 Content 노드에서 관계를 따라 확장:
     - Content → Article (HAS_CHUNK 관계)
     - Article → Category (BELONGS_TO 관계)
     - Article → Media (PUBLISHED 관계)
3. **관련성 점수 전파**
   - Content 노드의 유사도 점수를 Article 노드로 전파
   - Article의 relevance_score는 연결된 Content의 최고 유사도 점수
4. **필터링 및 반환**
   - relevance_score가 임계값 이상인 노드만 반환

### 장점
- **의미 검색 + 구조 탐색**: Vector 검색의 장점 + 그래프 구조 활용
- **더 풍부한 결과**: Content뿐만 아니라 Article, Category, Media도 함께 반환
- **관계 정보 포함**: 노드 간 관계(엣지)도 함께 반환
- **정확도 향상**: 그래프 구조를 통해 관련 노드를 확장하여 더 정확한 결과

### 단점
- **복잡성**: 두 단계 검색으로 인해 처리 시간이 더 걸림
- **확장 범위 제어**: 너무 많이 확장되면 관련 없는 노드가 포함될 수 있음

### 적합한 질의 예시
- "최근 AI 기술 동향을 분석해줘"
- "경제 뉴스의 주요 트렌드를 요약해줘"
- "정치 관련 기사들을 비교 분석해줘"
- "특정 카테고리의 AI 관련 기사"

---

## Retriever 선택 로직

시스템은 질의 내용에 따라 자동으로 Retriever를 선택합니다:

```python
# 구조적 키워드 포함 + 분석형 키워드 없음
→ Text2Cypher

# 5단어 이하 + 분석형 키워드 없음
→ Vector

# 그 외 (긴 질문 또는 분석형 키워드 포함)
→ VectorCypher
```

### 키워드 예시

**구조적 키워드**: "언론사", "카테고리", "분류", "속한", "발행", "관계", "어떤", "몇 개", "목록", "리스트", "모든"

**분석형 키워드**: "요약", "분석", "비교", "트렌드", "패턴", "관련", "영향", "원인", "결과", "의미"

---

## 문제 해결

### 1. Text2Cypher: 노드 0개 반환
**원인**: LLM이 생성한 Cypher 쿼리가 잘못되었거나, 쿼리 결과 파싱 문제

**해결**:
- 디버깅 로그 추가: 생성된 Cypher 쿼리와 실행 결과 확인
- 기본 쿼리 fallback: LLM 오류 시 기본 쿼리 사용
- 쿼리 검증: Cypher 쿼리 실행 전 문법 검사

### 2. Vector: 같은 노드 ID 반복
**원인**: Vector Index가 같은 노드를 여러 번 반환하거나, 중복 제거 로직 부재

**해결**:
- 중복 제거 로직 추가: `seen_node_ids` 집합으로 중복 제거
- 노드 ID 기반 필터링: 이미 추가된 노드는 제외

### 3. VectorCypher: 1개 노드만 반환
**원인**: Content 노드 ID 매칭 문제 (Neo4j 내부 ID vs properties.id)

**해결**:
- Neo4j 내부 ID 사용: `id(c)` 함수로 Neo4j 내부 ID 사용
- 디버깅 로그 추가: Content 노드 ID 매칭 과정 확인

---

## 테스트 권장사항

1. **각 Retriever별로 적합한 질의 사용**
   - Text2Cypher: 구조적 질문
   - Vector: 짧은 키워드
   - VectorCypher: 긴 분석 질문

2. **서버 로그 확인**
   - `[TEXT2CYPHER]`, `[VECTORCYPHER]` 로그로 각 단계 확인
   - 생성된 Cypher 쿼리와 실행 결과 확인

3. **결과 검증**
   - 반환된 노드 수가 예상과 일치하는지 확인
   - 노드의 타입과 속성이 올바른지 확인
   - 관계(엣지)가 올바르게 반환되는지 확인

---

## 참고 자료

- [RETRIEVER_TEST_QUERIES.md](./RETRIEVER_TEST_QUERIES.md): 각 Retriever별 테스트 질의 예시
- [README.md](./README.md): 프로젝트 전체 문서

